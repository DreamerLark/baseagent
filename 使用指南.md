# BaseAgent 使用指南

## 简介

BaseAgent 是一个基于 OpenAI API 格式的 AI 智能代理，支持：
- ✅ 自定义技能 (Skills) 注册和调用
- ✅ MCP (Model Context Protocol) 协议集成
- ✅ Function Calling 自动处理
- ✅ REST API 服务
- ✅ 对话历史管理

## 快速开始

### 1. 环境准备

```bash
# 克隆仓库后，进入项目目录
cd baseagent

# 运行安装脚本
./setup.sh

# 或手动安装
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. 配置 API Key

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填入你的 OpenAI API Key
# 支持 OpenAI 官方 API 或兼容格式的 API（如 Azure OpenAI、本地模型等）
```

.env 文件示例：
```
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4-turbo-preview
PORT=8000
```

### 3. 运行示例

#### 方式一：命令行交互

```bash
source venv/bin/activate
python example_usage.py
```

这将启动一个交互式对话，你可以直接与 Agent 对话。

#### 方式二：启动 API 服务器

```bash
source venv/bin/activate
python server.py
```

然后访问：
- API 文档：http://localhost:8000/docs
- 备用文档：http://localhost:8000/redoc

#### 方式三：使用 Docker

```bash
# 构建镜像
docker build -t baseagent .

# 运行容器
docker run -p 8000:8000 -e OPENAI_API_KEY=your-key-here baseagent

# 或使用 docker-compose
docker-compose up
```

## 核心功能详解

### 1. Skills（技能）系统

Skills 是 Agent 可以调用的函数工具。BaseAgent 内置了 5 个默认技能：

#### 内置技能列表

1. **calculate** - 数学计算
   - 支持：加减乘除、幂运算、平方根
   
2. **get_current_time** - 获取当前时间
   - 返回：日期、时间、ISO 格式时间戳

3. **read_file** - 读取文件
   - 读取指定路径的文件内容

4. **write_file** - 写入文件
   - 将内容写入指定文件

5. **search_text** - 文本搜索
   - 在文本中搜索关键词，返回匹配位置

#### 注册自定义技能

```python
from agent import BaseAgent

agent = BaseAgent()

# 定义技能函数
def get_weather(city: str, unit: str = "celsius") -> dict:
    """获取天气信息（示例）"""
    return {
        "city": city,
        "temperature": 22,
        "unit": unit,
        "condition": "晴天"
    }

# 注册到 Agent
agent.register_skill(
    name="get_weather",
    func=get_weather,
    description="获取指定城市的天气信息",
    parameters={
        "type": "object",
        "properties": {
            "city": {
                "type": "string",
                "description": "城市名称"
            },
            "unit": {
                "type": "string",
                "enum": ["celsius", "fahrenheit"],
                "description": "温度单位",
                "default": "celsius"
            }
        },
        "required": ["city"]
    }
)

# 使用
response = agent.chat("北京今天天气怎么样？")
print(response)
```

### 2. MCP（Model Context Protocol）集成

MCP 是一个标准化协议，允许 AI 应用与外部工具和数据源通信。

#### 添加 MCP 服务器

```python
from agent import BaseAgent
from mcp_client import MCPManager

# 创建实例
agent = BaseAgent()
mcp_manager = MCPManager()

# 添加 MCP 服务器
client = mcp_manager.add_server(
    name="filesystem",
    server_url="http://localhost:3000"
)

# 注册到 Agent
agent.register_mcp_server("filesystem", {"client": client})

# Agent 现在可以调用该 MCP 服务器的工具
```

#### MCP 服务器示例

假设你有一个 MCP 服务器提供文件系统操作：

```python
# 列出 MCP 服务器上的所有工具
tools = mcp_manager.list_all_tools()
print(tools)

# 直接调用 MCP 工具
result = mcp_manager.call_tool(
    server_name="filesystem",
    tool_name="list_directory",
    arguments={"path": "/tmp"}
)
print(result)
```

### 3. REST API 使用

#### 发送消息

```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "计算 123 * 456"
  }'
```

#### 执行技能

```bash
curl -X POST http://localhost:8000/skills/execute \
  -H "Content-Type: application/json" \
  -d '{
    "skill_name": "calculate",
    "arguments": {
      "operation": "multiply",
      "a": 123,
      "b": 456
    }
  }'
```

#### 查看所有技能

```bash
curl http://localhost:8000/skills
```

#### 添加 MCP 服务器

```bash
curl -X POST http://localhost:8000/mcp/servers \
  -H "Content-Type: application/json" \
  -d '{
    "name": "my_mcp_server",
    "server_url": "http://localhost:3000"
  }'
```

## 高级用法

### 1. 自定义 Agent 行为

```python
from agent import BaseAgent

class CustomAgent(BaseAgent):
    def chat(self, message: str, stream: bool = False) -> str:
        # 添加消息预处理
        print(f"[预处理] 收到消息: {message}")
        
        # 调用父类方法
        response = super().chat(message, stream)
        
        # 添加响应后处理
        print(f"[后处理] 生成响应: {response}")
        
        return response

# 使用自定义 Agent
agent = CustomAgent()
```

### 2. 管理对话历史

```python
# 获取对话历史
history = agent.get_conversation_history()
print(history)

# 重置对话
agent.reset_conversation()
```

### 3. 扩展技能系统

```python
from skills import SkillRegistry

# 创建技能注册表
registry = SkillRegistry()

# 添加自定义技能
def translate_text(text: str, target_lang: str) -> dict:
    # 实现翻译逻辑
    return {"translated": f"[{target_lang}] {text}"}

registry.register(
    name="translate",
    func=translate_text,
    description="翻译文本",
    parameters={
        "type": "object",
        "properties": {
            "text": {"type": "string", "description": "要翻译的文本"},
            "target_lang": {"type": "string", "description": "目标语言"}
        },
        "required": ["text", "target_lang"]
    }
)

# 将所有技能注册到 Agent
for skill_name, skill_info in registry.get_all_skills().items():
    agent.register_skill(
        name=skill_name,
        func=lambda **kwargs: registry.execute(skill_name, **kwargs),
        description=skill_info["description"],
        parameters=skill_info["parameters"]
    )
```

## 使用场景示例

### 场景 1：数学计算助手

```python
agent = BaseAgent()
# 使用内置的 calculate 技能

response = agent.chat("帮我计算一下，如果我每天存 100 元，一年能存多少？")
# Agent 会自动调用 calculate 技能：100 * 365 = 36500
```

### 场景 2：文件处理助手

```python
response = agent.chat("请读取 /tmp/data.txt 文件的内容")
# Agent 会调用 read_file 技能

response = agent.chat("将 'Hello World' 写入到 /tmp/output.txt")
# Agent 会调用 write_file 技能
```

### 场景 3：集成外部 API

```python
# 添加天气技能
def get_real_weather(city: str) -> dict:
    import requests
    # 调用真实的天气 API
    response = requests.get(f"https://api.weather.com/v1/{city}")
    return response.json()

agent.register_skill(
    name="get_weather",
    func=get_real_weather,
    description="获取实时天气",
    parameters={...}
)

# 使用
response = agent.chat("上海今天天气如何？")
```

## 故障排查

### 问题 1：Import Error

```
ModuleNotFoundError: No module named 'openai'
```

**解决方案：**
```bash
# 确保已激活虚拟环境
source venv/bin/activate

# 重新安装依赖
pip install -r requirements.txt
```

### 问题 2：API Key 错误

```
Error: OpenAI API key not configured
```

**解决方案：**
1. 检查 .env 文件是否存在
2. 确认 OPENAI_API_KEY 已正确设置
3. 确保 .env 文件在项目根目录

### 问题 3：端口被占用

```
Error: Address already in use
```

**解决方案：**
```bash
# 修改 .env 中的 PORT 值
PORT=8001

# 或者在启动时指定
PORT=8001 python server.py
```

## 性能优化建议

1. **使用较快的模型**：对于简单任务，可以使用 gpt-3.5-turbo 代替 gpt-4
2. **启用缓存**：对于重复的技能调用，可以添加缓存层
3. **异步处理**：对于 I/O 密集型技能，使用异步函数
4. **批量处理**：一次对话中尽量合并多个相关请求

## 安全注意事项

1. **API Key 保护**：
   - 不要将 .env 文件提交到版本控制
   - 使用环境变量或密钥管理服务
   
2. **文件操作限制**：
   - 限制 read_file/write_file 的路径访问范围
   - 添加文件大小限制
   
3. **输入验证**：
   - 对用户输入进行验证和清理
   - 防止注入攻击

## 进一步学习

- [OpenAI API 文档](https://platform.openai.com/docs)
- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [MCP 协议规范](https://modelcontextprotocol.io/)

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License
